#!/usr/bin/env ruby

$LOAD_PATH.prepend File.join(__dir__, "..", "lib")

require "runners"
require "runners/cli"

EXIT_STATUS_FOR_SIGTERM = 126

trap('SIGTERM') do
  Bugsnag.notify(Runners::TimeoutError.new)
  exit(EXIT_STATUS_FOR_SIGTERM)
end

trap('SIGUSR2') do
  Bugsnag.notify(Runners::TimeoutError.new)
end

begin
  # @see https://docs.aws.amazon.com/sdk-for-ruby/v3/developer-guide/setup-config.html
  if ENV["AWS_ACCESS_KEY_ID"]
    Aws.config[:credentials] = Aws::Credentials.new(ENV.delete("AWS_ACCESS_KEY_ID"), ENV.delete("AWS_SECRET_ACCESS_KEY"))
  end
  if ENV["AWS_REGION"]
    Aws.config[:region] = ENV.delete("AWS_REGION")
  end

  Runners::CLI.new(
    argv: ARGV.dup,
    stdout: STDOUT,
    stderr: STDERR,
    options_json: ENV.delete("RUNNERS_OPTIONS"),
  ).run
rescue => exn
  Bugsnag.notify(exn)
  raise
end
