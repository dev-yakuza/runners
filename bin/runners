#!/usr/bin/env ruby

require "pathname"

$LOAD_PATH << Pathname(__dir__).parent + "lib"

require "bugsnag"
require "runners"
require "runners/cli"

class RunnersTimeoutError < StandardError; end

EXIT_STATUS_FOR_SIGTERM = 126

Bugsnag.configure do |config|
  config.app_version = ENV["RUNNERS_VERSION"]
end

def notify_with_bugsnag(exception)
  Bugsnag.notify(exception) do |report|
    report.add_tab(:task_guid, ENV["TASK_GUID"]) if ENV["TASK_GUID"]
  end
end

trap('SIGTERM') do
  notify_with_bugsnag(RunnersTimeoutError.new)
  exit(EXIT_STATUS_FOR_SIGTERM)
end

trap('SIGUSR2') do
  notify_with_bugsnag(RunnersTimeoutError.new)
end

at_exit do
  notify_with_bugsnag($!) if $!
end

result = Runners::CLI.new(argv: ARGV, stdout: STDOUT, stderr: STDERR).validate_options!.run
if result.instance_of?(Runners::Results::Error)
  notify_with_bugsnag(result.exception)
end
